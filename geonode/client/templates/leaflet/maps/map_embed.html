<html>
<head>
    <title>Mapa</title>
    <link rel="stylesheet" href="/static/leaflet/leaflet.css" />
    <link rel="stylesheet" href="/static/lib/css/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/static/lib/css/leaflet-plugins.min.css" type="text/css" />
    <link rel="stylesheet" href="/static/lib/css/L.Control.Pan.css" type="text/css" />
    <script src="/static/leaflet/leaflet.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4-src.js"></script>
    <script src="/static/lib/js/leaflet-plugins.min.js" type="text/javascript"></script>
    <script src="/static/leaflet/leaflet.extras.js" type="text/javascript"></script>
    <script src="/static/lib/js/L.Control.Pan.js"></script>
    <script src="/static/lib/js/printjs/leaflet.browser.print.js"></script>
    <script src="/static/lib/js/printjs/leaflet.browser.print.sizes.js"></script>
    <script src="/static/lib/js/printjs/leaflet.browser.print.utils.js"></script>
    <script src="/static/lib/js/printjs/leaflet.draw.js"></script>
    <script src="/static/lib/js/L.TileLayer.BetterWMS.js"></script>
    <script src="/static/lib/js/leaflet-hash.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.mapbox.css' rel='stylesheet' />  
    <script type="text/javascript">
        $(document).ready(function () {
            /* init custom layer */
            var wmsLayer = null;
            /* set coordinate systems */
            var firstProjection = proj4('EPSG:3857');   // google mercator
            var secondProjection = proj4('EPSG:4326');  // WGS84 web mercator
	        //Center for Montenegro
            var point_wsg84 = [19.2,42.7]; //proj4(firstProjection,secondProjection,[18,42]);
            var map = L.map('map').setView([point_wsg84[1], point_wsg84[0]],9);

	        var scale_bar = L.control.scale().addTo(map);
            var fs=L.control.fullscreen().addTo(map);
	        var nb=L.control.navbar().addTo(map);
	        var podloga;

            var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            });

            var unesco = L.tileLayer(
                'http://en.unesco.org/tiles/{z}/{x}/{y}.png', {
                attribution: '&copy; unesco'
            });

            var unesco_geodata = L.tileLayer(
                'http://en.unesco.org/tiles/geodata/{z}/{x}/{y}.png', {
                attribution: '&copy; unesco'
            });

            var OpenMapSurfer_Roads = L.tileLayer('', {
            });

            // not yet available
            var unesco_white = L.tileLayer(
                'http://en.unesco.org/tiles/white/{z}/{x}/{y}.png', {
                attribution: '&copy; unesco'
            });

        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
            maxZoom: 19,
            subdomains:['mt0','mt1','mt2','mt3']
        });

        var googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        })

        var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        });

            var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3']
            });

        var base_maps = {
            "NO BACKGROUND": OpenMapSurfer_Roads,
            'OpenStreetMap': osm,
	        'SATELLITE': googleSat,
            'TERRAIN': googleTerrain,
            'HYBRID': googleHybrid,
            'ROAD': googleStreets
        };
	    var overlay_layer = {};
	    var options = {};
        /* zoom to bbox */
		var brojac = 0;
		var i=0;
        firstProjection = proj4('EPSG:3857');
	    {%for layer in map_layers%}	
            var layer_url = '{{  layer.ows_url }}';

		    if ('{{layer.group}}' == 'background') {
               	for(var key in base_maps){
                    if(base_maps[key]._url == '{{layer.ows_url}}'.replace(/&amp;/g,'&').replace(/&amp;/g,'&')){
                        if ('{{layer.visibility}}' == 'True') {
                        brojac=i;
                        podloga = base_maps[key];
                        map.addLayer(base_maps[key]);
                        }
			        }   
		         }
			    i++;
            }else {
                // wmsLayer = L.tileLayer.wms(layer_url, options);
			    wmsLayer = L.tileLayer.betterWms(layer_url,
                    {
                       	format: 'image/png', transparent: true, layers:'{{ layer.name }}'
                    });
		        overlay_layer["{{ layer.name }}"] = wmsLayer;
                    }
                    /* add wmsLayer to the map object itself */
                    if (wmsLayer != null) {
                        map.addLayer(wmsLayer);
                    }
            {% endfor %}
	 var layerControl = L.control.layers(
                base_maps, overlay_layer
         ).addTo(map);
	 $('.leaflet-control-layers-selector')[brojac].click();
	var hash = new L.Hash(map);
               var locateMe= L.control.locate({
                    strings: {
                        title: "Locate me"
                    }
                }).addTo(map);
	var plugin = L.control.measure({
        position: 'topright',
		primaryLengthUnit: 'meters',
		secondaryLengthUnit: null,
		primaryAreaUnit: 'sqmeters',
		activeColor: "#ff0000",
		completedColor: "#000000",
      }).addTo(map);
        var drawnItems = new L.FeatureGroup();
        var drawControl = new L.Control.Draw({
                position: 'bottomright',
                edit: {
                        featureGroup: drawnItems,
                        remove: false,
                        edit: false
                },
                draw: {
                        circlemarker: false,
                }
        });
        map.addControl(drawControl);
        map.createPane("new-pane");
        map.on(L.Draw.Event.CREATED, function (e) {
                var type = e.layerType,
                layer = e.layer;
                        if (type === 'marker') {
                                layer.bindPopup('A popup!');
                            }
                            drawnItems.addLayer(layer);
                                map.addLayer(drawnItems);
                        });

            var print_control = L.control.browserPrint({
                printLayer: L.tileLayer(podloga._url,podloga.options),
                closePopupsOnPrint: false,
                                printModes: [
                                        L.control.browserPrint.mode.landscape(),
                                        "PORTrait",
                                        L.control.browserPrint.mode.auto("Auto", "B4"),
                                        L.control.browserPrint.mode.custom("Select print area", "B5")
                                ]

            }).addTo(map);
		map.on('baselayerchange', function(e){
			print_control.options.printLayer = e.layer;				
		});

        var canvasRenderer = L.canvas();

                        L.Control.BrowserPrint.Utils.registerLayer(L.TileLayer.WMS, 'L.TileLayer.WMS', function(layer) {
                                return L.tileLayer.wms(layer._url, layer.options);
                        });

        });
    </script>
    <style>
        #map { height: 100%; }
    </style>
</head>

<body>
    <div id="map"></div>
</body>
</html>
